{% extends "base.html" %}

{% block content %}
<div class="page-container">
    <div class="admin-header">
        <h2 class="page-title">Admin Panel - Edit Past Data</h2>
        <form method="POST" action="{{ url_for('admin') }}" style="display: inline;">
            <input type="hidden" name="logout" value="1">
            <button type="submit" class="btn btn-secondary">Logout</button>
        </form>
    </div>
    
    <div class="admin-controls">
        <form method="GET" action="{{ url_for('admin') }}" class="filter-form">
            <label for="days">View last:</label>
            <select name="days" id="days" class="form-select" onchange="this.form.submit()">
                <option value="7" {% if days_back == 7 %}selected{% endif %}>7 days</option>
                <option value="14" {% if days_back == 14 %}selected{% endif %}>14 days</option>
                <option value="30" {% if days_back == 30 %}selected{% endif %}>30 days</option>
                <option value="60" {% if days_back == 60 %}selected{% endif %}>60 days</option>
            </select>
        </form>
    </div>
    
    <div class="admin-member-management">
        <h3 class="section-title">Member Management</h3>
        <div class="member-management-grid">
            <div class="add-member-section">
                <h4>Add New Member</h4>
                <form method="POST" action="{{ url_for('admin') }}" class="add-member-form">
                    <input type="hidden" name="add_member" value="1">
                    <div class="form-group">
                        <input type="text" name="member_name" class="form-input" 
                               placeholder="Enter member name" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Member</button>
                </form>
            </div>
            
            <div class="remove-member-section">
                <h4>Remove Member</h4>
                <form method="POST" action="{{ url_for('admin') }}" class="remove-member-form" 
                      onsubmit="return confirm('Are you sure you want to remove this member? This will delete all their meal records!');">
                    <input type="hidden" name="remove_member" value="1">
                    <div class="form-group">
                        <select name="member_id" class="form-select" required>
                            <option value="">Select Member to Remove</option>
                            {% for member in members %}
                            <option value="{{ member.id }}">{{ member.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-danger">Remove Member</button>
                </form>
            </div>
        </div>
        
        <div class="members-list-admin">
            <h4>All Members ({{ members|length }})</h4>
            {% if members %}
            <div class="members-grid-admin">
                {% for member in members %}
                <div class="member-card-admin">
                    <span class="member-name">{{ member.name }}</span>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="empty-state">No members added yet.</p>
            {% endif %}
        </div>
    </div>
    
    <div class="admin-edit-form">
        <h3 class="section-title">Edit/Create Meal Record</h3>
        <form method="POST" action="{{ url_for('admin') }}" class="edit-meal-form">
            <input type="hidden" name="update_meal" value="1">
            <div class="form-row">
                <div class="form-group">
                    <label for="edit_member_id">Member:</label>
                    <select name="member_id" id="edit_member_id" class="form-select" required>
                        <option value="">Select Member</option>
                        {% for member in members %}
                        <option value="{{ member.id }}">{{ member.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit_meal_date">Date:</label>
                    <input type="date" name="meal_date" id="edit_meal_date" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="edit_meal_count">Meal Count:</label>
                    <select name="meal_count" id="edit_meal_count" class="form-select" required>
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </div>
            <input type="hidden" name="record_id" id="edit_record_id" value="">
        </form>
    </div>
    
    <div class="admin-records">
        <h3 class="section-title">Past Records ({{ start_date.strftime('%Y-%m-%d') }} to {{ end_date.strftime('%Y-%m-%d') }})</h3>
        
        {% if records_by_date %}
        <div class="records-list">
            {% for date_str, records in records_by_date.items() %}
            <div class="record-date-group">
                <h4 class="record-date-header">
                    <span style="margin-right: 8px;">ðŸ“…</span>{{ date_str }}
                </h4>
                <div class="record-items">
                    {% for record in records %}
                    <div class="record-item">
                        <span class="record-member">{{ record.member.name }}</span>
                        <span class="record-count">Meals: {{ record.meal_count }}</span>
                        <button class="btn btn-small btn-edit" 
                                onclick="editRecord('{{ record.id }}', '{{ record.member_id }}', '{{ record.meal_date }}', '{{ record.meal_count }}')">
                            Edit
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <p>No records found for the selected period.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
function editRecord(recordId, memberId, mealDate, mealCount) {
    document.getElementById('edit_record_id').value = recordId;
    document.getElementById('edit_member_id').value = memberId;
    document.getElementById('edit_meal_date').value = mealDate;
    document.getElementById('edit_meal_count').value = mealCount;
    
    // Scroll to edit form
    document.querySelector('.admin-edit-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
}
</script>
{% endblock %}
